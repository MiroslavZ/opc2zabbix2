# Универсальный OPC-шлюз

Мониторинг OPC-серверов и выдача показателей узлов сторонним сервисам через api

При запуске приложения происходит чтение excel документа и конфигурационного файла.
- В excel документе содержатся листы. 
  Имя листа соответствует имени OPC-сервера и совпадает с таковым в .env файле. 
  В листе таблица из трех столбцов Item, Key и Node.
  - Item - имя узла
  - Key - ключ для получения измерений узла
  - Node - node id адрес узла в OPC-сервере
- В конфигурационном файле находятся словарь серверов в виде JSON-строки 
  (пример SERVERS='{"MyServer1":"opc.tcp://localhost:54000"}') 
  и уровень логирования (пример LOG_LEVEL='WARNING').

Далее осуществляется планирование задач на подключение и поддержку связи с серверами. 
Повторное подключение реализовано через бесконечный цикл, state-машину со следующими состояниями:
1. Подключение к серверу
2. Получение узлов и подписка на них
3. Циклическая проверка состояния сервера и узлов (проблемы => состояние 4)
4. В случае проблем — отписка от узлов, удаление подписки, 
   отключение OPC-клиента, возврат к состоянию 1


## Методы API

Получение последнего измерения для узла по ключу. Ключ соответствует полю Key из excel документа.  
`@app.get("/measurements/{key}")`
```  
Пример ответа:
{
  "node_id": "ns=1;s=PN_SIMULATOR.PD_SIMULATOR.SubDevice1.TestTag2",
  "display_name": "TestTag2",
  "value_type": 6,
  "last_value": -9,
  "health_is_good": true
}
``` 
Получение статуса сервера по его имени. Статус включает в себя наличие подключения и значение service level узла сервера. При отсутствии service level узла значение "unknown"  
`@app.get("/servers/{name}")`
```
Пример ответа:
{
  "connected": true,
  "service_level": "unknown"
}  
```
Управление шлюзом осуществляется с помощью отправки команд stop, start, restart  
`@app.get("/control/{command}")`

